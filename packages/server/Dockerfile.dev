# node for server and build.
FROM node:19.5-alpine as base

# Install build dependencies
RUN apk --no-cache add --virtual .builds-deps build-base python3

RUN npm install --global node-gyp

FROM base as build

# set base path
WORKDIR /build

# copy source files
COPY . .

# install dependencies
RUN yarn

# Remove any existing .env file
RUN rm -f .env

# Copy .env.prod to .env
RUN cp .env.prod .env

# generate secrets
RUN python3 ./bin/secrets.py .env

# build prisma
RUN yarn prisma generate

# build package
RUN yarn build:dist

# Remove build dependencies after the build process is complete
RUN apk del .builds-deps

# packages are in dist
FROM build as assets

WORKDIR /app

COPY --from=build /build/dist .

# install dependencies
RUN yarn

# generate dependencies
RUN yarn prisma generate

# run the server
CMD ["yarn", "serve"]
